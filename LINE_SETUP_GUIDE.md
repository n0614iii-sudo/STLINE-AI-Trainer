# 📱 LINE通知機能セットアップガイド

## ✅ 実装完了

姿勢診断結果をLINE Messaging APIでお客様に送信する機能を実装しました！

## 🎯 機能概要

- 姿勢診断結果をLINEで自動送信
- 総合スコア、整列スコア、問題点、改善提案、筋肉評価を含む
- 診断結果レポート画像も送信
- ユーザーごとにLINEユーザーIDを登録可能

## 🔧 LINE Messaging APIの設定

### ステップ1: LINE Developersアカウントの作成

1. [LINE Developers](https://developers.line.biz/ja/)にアクセス
2. LINEアカウントでログイン
3. プロバイダーを作成（初回のみ）

### ステップ2: チャネルの作成

1. LINE Developersコンソールで「チャネルを作成」をクリック
2. 「Messaging API」を選択
3. チャネル情報を入力：
   - チャネル名: `STLINE AI パーソナルトレーナー`（任意）
   - チャネル説明: `姿勢診断結果を送信するためのチャネル`（任意）
   - カテゴリー: `健康・医療`（任意）
   - サブカテゴリー: `その他`（任意）
4. 利用規約に同意して作成

### ステップ3: チャネルアクセストークンの取得

1. 作成したチャネルの「Messaging API」タブを開く
2. 「チャネルアクセストークン（長期）」セクションで「発行」をクリック
3. 表示されたトークンをコピー（後で使用します）

### ステップ4: Webhook URLの設定（オプション）

メッセージの受信が必要な場合のみ設定：

1. 「Messaging API」タブの「Webhook URL」セクション
2. Webhook URLを入力（例: `https://your-domain.com/webhook/line`）
3. 「検証」をクリックして接続を確認
4. 「Webhookの利用」を有効化

### ステップ5: 環境変数の設定

#### ローカル環境

`.env`ファイルに以下を追加：

```env
LINE_CHANNEL_ACCESS_TOKEN=your_channel_access_token_here
```

#### Railway環境

1. Railwayダッシュボードでプロジェクトを開く
2. 「Variables」タブを開く
3. 新しい環境変数を追加：
   - キー: `LINE_CHANNEL_ACCESS_TOKEN`
   - 値: ステップ3で取得したチャネルアクセストークン
4. 「Add」をクリック

## 📝 LINEユーザーIDの取得方法

### 方法1: Webhookを使用（推奨）

1. LINE Messaging APIのWebhookを有効化
2. ユーザーがLINE Botにメッセージを送信
3. Webhookで受信したイベントから`source.userId`を取得

### 方法2: LINEログインを使用

1. LINE Loginチャネルを作成
2. ユーザーにLINEログインを実行してもらう
3. 認証後のコールバックでユーザーIDを取得

### 方法3: 手動入力

1. 姿勢診断ページで「LINEで送信」ボタンをクリック
2. LINEユーザーIDの入力プロンプトが表示される
3. ユーザーIDを入力（初回のみ）
4. 次回からは自動的に使用されます

## 🚀 使用方法

### 1. 姿勢診断を実行

1. 姿勢診断ページにアクセス
2. カメラで姿勢を撮影、または画像をアップロード
3. 診断結果が表示される

### 2. LINEで送信

1. 診断結果が表示されたら「LINEで送信」ボタンをクリック
2. LINEユーザーIDが未設定の場合は入力プロンプトが表示される
3. LINEユーザーIDを入力（初回のみ）
4. 送信完了のメッセージが表示される

### 3. LINEで確認

お客様のLINEに以下の内容が送信されます：

- 📊 総合スコア
- 📐 整列スコア（肩、骨盤、頭部、背骨、膝）
- ⚠️ 検出された問題
- 💡 改善提案
- 💪 筋肉評価（硬い筋肉、ストレッチ、強化）
- 🖼️ 診断結果レポート画像

## 📋 送信されるメッセージの内容

### 1. タイトルメッセージ

```
🟢 姿勢診断結果レポート

[ユーザー名]様の姿勢診断が完了しました。

📊 総合スコア: 85/100点
📅 診断日時: 2026年1月5日 10:43
```

### 2. 整列スコア

```
📐 整列スコア:
🟢 肩の水平度: 95点
🟢 骨盤の水平度: 97点
🟡 頭部の位置: 74点
🟢 背骨の整列: 100点
🟢 膝の位置: 96点
```

### 3. 検出された問題

```
⚠️ 検出された問題:

🔴 反り腰の傾向があります(後傾角度:89.5度)
   → 腰痛、骨盤の歪み、股関節の痛みの原因になる可能性があります

🔵 頭部がわずかに中心からずれています
   → 長時間の姿勢不良の原因になる可能性があります
```

### 4. 改善提案

```
💡 改善提案:

1. 腹筋と背筋のバランスを整えましょう
2. 骨盤底筋を鍛えるエクササイズを推奨します
3. 腰を支える筋肉を強化しましょう
```

### 5. 筋肉評価

```
💪 筋肉評価:

🔴 硬い可能性のある筋肉:
  • 腰方形筋
  • 腸腰筋

🟢 ストレッチが必要:
  • 腰方形筋: 座位での側屈ストレッチ

🔵 強化が必要:
  • 腹横筋: プランク
```

### 6. 診断結果レポート画像

診断結果レポート画像が送信されます。

## 🔒 セキュリティ

- チャネルアクセストークンは環境変数で管理
- LINEユーザーIDはユーザープロファイルに保存
- 送信前にユーザー認証を確認

## 🐛 トラブルシューティング

### エラー: LINE通知機能は利用できません

**原因**: `LINE_CHANNEL_ACCESS_TOKEN`が設定されていない

**解決方法**:
1. `.env`ファイルまたはRailwayの環境変数に`LINE_CHANNEL_ACCESS_TOKEN`を設定
2. アプリケーションを再起動

### エラー: LINEユーザーIDが必要です

**原因**: ユーザーのLINEユーザーIDが登録されていない

**解決方法**:
1. 「LINEで送信」ボタンをクリック
2. LINEユーザーIDを入力
3. 次回からは自動的に使用されます

### エラー: LINE通知の送信に失敗しました

**原因**: 
- チャネルアクセストークンが無効
- LINEユーザーIDが無効
- ネットワークエラー

**解決方法**:
1. チャネルアクセストークンを再発行
2. LINEユーザーIDを確認
3. ネットワーク接続を確認

## 📚 参考リンク

- [LINE Messaging API ドキュメント](https://developers.line.biz/ja/docs/messaging-api/)
- [LINE Developers コンソール](https://developers.line.biz/console/)
- [LINE Messaging API リファレンス](https://developers.line.biz/ja/reference/messaging-api/)

## 🎉 まとめ

- ✅ LINE Messaging APIの設定
- ✅ チャネルアクセストークンの取得
- ✅ 環境変数の設定
- ✅ LINEユーザーIDの登録
- ✅ 姿勢診断結果の送信

姿勢診断結果をLINEでお客様に送信できるようになりました！🎉



