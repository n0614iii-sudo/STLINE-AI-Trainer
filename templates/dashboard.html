{% extends "base.html" %}

{% block title %}ダッシュボード - STLINE AI Personal Trainer{% endblock %}
{% block page_title %}ダッシュボード{% endblock %}

{% block content %}
<div class="row mb-4">
    <!-- 統計カード - 3D効果 -->
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-3d">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 1px;">
                        総ユーザー数
                    </div>
                    <div class="h2 mb-0 text-white fw-bold">{{ total_users }}</div>
                </div>
                <div class="stat-icon text-white">
                    <i class="fas fa-users"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-3d">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 1px;">
                        総セッション数
                    </div>
                    <div class="h2 mb-0 text-white fw-bold">{{ total_sessions }}</div>
                </div>
                <div class="stat-icon text-white">
                    <i class="fas fa-dumbbell"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-3d">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 1px;">
                        今日のセッション
                    </div>
                    <div class="h2 mb-0 text-white fw-bold" id="today-sessions">-</div>
                </div>
                <div class="stat-icon text-white">
                    <i class="fas fa-calendar-day"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
        <div class="stats-card-3d">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="text-white-50 text-uppercase mb-2" style="font-size: 0.75rem; letter-spacing: 1px;">
                        週間セッション
                    </div>
                    <div class="h2 mb-0 text-white fw-bold" id="week-sessions">-</div>
                </div>
                <div class="stat-icon text-white">
                    <i class="fas fa-chart-line"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <!-- 最近のセッション - 3Dカード -->
    <div class="col-lg-8 mb-4">
        <div class="card-3d">
            <div class="card-header">
                <i class="fas fa-list me-2"></i> 最近のトレーニングセッション
            </div>
            <div class="card-body text-white">
                {% if recent_sessions %}
                <div class="table-responsive">
                    <table class="table table-glass text-white">
                        <thead>
                            <tr>
                                <th class="text-white">ユーザー</th>
                                <th class="text-white">運動</th>
                                <th class="text-white">日時</th>
                                <th class="text-white">回数</th>
                                <th class="text-white">フォームスコア</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in recent_sessions %}
                            <tr>
                                <td>
                                    <i class="fas fa-user-circle me-2"></i>{{ session.user_name }}
                                </td>
                                <td>
                                    <span class="badge-3d" style="background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);">
                                        {{ session.exercise }}
                                    </span>
                                </td>
                                <td class="text-white-50">{{ session.date }}</td>
                                <td class="fw-bold">{{ session.reps }}回</td>
                                <td>
                                    {% if session.form_score >= 0.8 %}
                                        <span class="badge-3d" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                                            {{ session.form_score }}
                                        </span>
                                    {% elif session.form_score >= 0.6 %}
                                        <span class="badge-3d" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                            {{ session.form_score }}
                                        </span>
                                    {% else %}
                                        <span class="badge-3d" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);">
                                            {{ session.form_score }}
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-white-50 py-5">
                    <i class="fas fa-inbox fa-4x mb-3" style="opacity: 0.5;"></i>
                    <p>まだセッションデータがありません</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 運動別統計 - 3Dカード -->
    <div class="col-lg-4 mb-4">
        <div class="card-3d">
            <div class="card-header">
                <i class="fas fa-chart-pie me-2"></i> 週間運動統計
            </div>
            <div class="card-body text-white">
                <canvas id="exerciseChart" width="100" height="100"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- クイックアクション - 3Dカード -->
<div class="row">
    <div class="col-12">
        <div class="card-3d">
            <div class="card-header">
                <i class="fas fa-bolt me-2"></i> クイックアクション
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('add_user') }}" class="btn btn-3d w-100 d-block text-decoration-none">
                            <i class="fas fa-user-plus fa-2x mb-2"></i><br>
                            <span>新規ユーザー登録</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <button class="btn btn-3d w-100" onclick="startTrainingSession()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                            <i class="fas fa-play-circle fa-2x mb-2"></i><br>
                            <span>セッション開始</span>
                        </button>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('users_list') }}" class="btn btn-3d w-100 d-block text-decoration-none" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <i class="fas fa-users fa-2x mb-2"></i><br>
                            <span>ユーザー一覧</span>
                        </a>
                    </div>
                    <div class="col-md-3 col-sm-6 mb-3">
                        <a href="{{ url_for('exercises_list') }}" class="btn btn-3d w-100 d-block text-decoration-none" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                            <i class="fas fa-dumbbell fa-2x mb-2"></i><br>
                            <span>運動メニュー</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 統計データを取得して表示
    fetch('/api/stats')
        .then(response => response.json())
        .then(data => {
            document.getElementById('today-sessions').textContent = data.today_sessions;
            document.getElementById('week-sessions').textContent = data.week_sessions;
            
            // 円グラフを作成（3D効果付き）
            const ctx = document.getElementById('exerciseChart').getContext('2d');
            const exerciseNames = Object.values(data.exercise_stats).map(stat => stat.name);
            const exerciseCounts = Object.values(data.exercise_stats).map(stat => stat.count);
            
            if (exerciseNames.length > 0) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: exerciseNames,
                        datasets: [{
                            data: exerciseCounts,
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(240, 147, 251, 0.8)',
                                'rgba(245, 87, 108, 0.8)',
                                'rgba(79, 172, 254, 0.8)',
                                'rgba(0, 242, 254, 0.8)'
                            ],
                            borderColor: [
                                'rgba(102, 126, 234, 1)',
                                'rgba(118, 75, 162, 1)',
                                'rgba(240, 147, 251, 1)',
                                'rgba(245, 87, 108, 1)',
                                'rgba(79, 172, 254, 1)',
                                'rgba(0, 242, 254, 1)'
                            ],
                            borderWidth: 2,
                            hoverOffset: 10
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.9)',
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                borderColor: 'rgba(240, 147, 251, 0.5)',
                                borderWidth: 1
                            }
                        },
                        animation: {
                            animateRotate: true,
                            animateScale: true
                        }
                    }
                });
            } else {
                ctx.canvas.style.display = 'none';
                const container = ctx.canvas.parentElement;
                container.innerHTML = '<div class="text-center text-white-50 py-4"><i class="fas fa-chart-pie fa-4x mb-3" style="opacity: 0.5;"></i><p>統計データがありません</p></div>';
            }
        })
        .catch(error => {
            console.error('統計データの取得に失敗しました:', error);
        });
</script>
{% endblock %}
