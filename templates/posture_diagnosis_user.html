{% extends "base.html" %}

{% block title %}{{ user.name }} - 姿勢診断{% endblock %}
{% block page_title %}<i class="fas fa-user-md"></i> {{ user.name }}さんの姿勢診断{% endblock %}

{% block content %}
<div class="row">
    <!-- 姿勢診断カメラ -->
    <div class="col-md-8">
        <div class="card-3d mb-4">
            <div class="card-header">
                <h5 class="mb-0 text-white"><i class="fas fa-video me-2"></i> リアルタイム姿勢診断</h5>
            </div>
            <div class="card-body text-white">
                <div id="camera-container" class="position-relative">
                    <video id="video" autoplay playsinline style="width: 100%; max-width: 640px; border-radius: 0.5rem;"></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    <div id="overlay" class="position-absolute top-0 start-0 w-100 h-100" style="pointer-events: none;"></div>
                </div>
                
                <div class="mt-3">
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-3d" id="startBtn" onclick="startPostureDiagnosis()">
                            <i class="fas fa-play me-2"></i> 診断開始
                        </button>
                        <button type="button" class="btn btn-3d" id="stopBtn" onclick="stopPostureDiagnosis()" disabled style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                            <i class="fas fa-stop me-2"></i> 診断停止
                        </button>
                        <button type="button" class="btn btn-3d" id="captureBtn" onclick="capturePosture()" disabled style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                            <i class="fas fa-camera me-2"></i> 現在の姿勢を分析
                        </button>
                    </div>
                </div>
                
                <div class="mt-3">
                    <label class="form-label text-white">姿勢タイプ</label>
                    <select class="form-select bg-dark text-white border-secondary" id="postureType">
                        <option value="standing">立位</option>
                        <option value="sitting">座位</option>
                        <option value="walking">歩行中</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- 診断結果表示エリア -->
        <div class="card-3d" id="resultCard" style="display: none;">
            <div class="card-header">
                <h5 class="mb-0 text-white"><i class="fas fa-chart-line me-2"></i> 診断結果</h5>
            </div>
            <div class="card-body text-white" id="resultContent">
                <!-- 結果がここに表示されます -->
            </div>
        </div>
    </div>
    
    <!-- サイドバー情報 -->
    <div class="col-md-4">
        <!-- 最新の診断結果 -->
        {% if latest_analysis %}
        <div class="card-3d mb-4">
            <div class="card-header" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.3) 0%, rgba(5, 150, 105, 0.3) 100%);">
                <h5 class="mb-0 text-white"><i class="fas fa-check-circle me-2"></i> 最新の診断結果</h5>
            </div>
            <div class="card-body text-white">
                <div class="text-center mb-3">
                    <div class="display-4 fw-bold" style="color: #10b981;">
                        {{ "%.0f"|format(latest_analysis.overall_score * 100) }}
                    </div>
                    <div class="text-muted">総合スコア</div>
                </div>
                
                <div class="mb-3">
                    <strong>診断日時:</strong><br>
                    <small class="text-muted">{{ latest_analysis.timestamp.strftime('%Y年%m月%d日 %H:%M') }}</small>
                </div>
                
                <div class="mb-3">
                    <strong>姿勢タイプ:</strong><br>
                    <span class="badge bg-info">
                        {% if latest_analysis.posture_type == 'standing' %}立位
                        {% elif latest_analysis.posture_type == 'sitting' %}座位
                        {% elif latest_analysis.posture_type == 'walking' %}歩行中
                        {% else %}{{ latest_analysis.posture_type }}{% endif %}
                    </span>
                </div>
                
                {% if latest_analysis.issues %}
                <div class="mb-3">
                    <strong>検出された問題:</strong>
                    <ul class="list-unstyled mt-2">
                        {% for issue in latest_analysis.issues %}
                        <li class="mb-1">
                            <span class="badge bg-{% if issue.severity == 'high' %}danger{% elif issue.severity == 'medium' %}warning{% else %}info{% endif %}">
                                {{ issue.description }}
                            </span>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
                
                <a href="{{ url_for('posture_diagnosis_user', user_id=user.user_id) }}" class="btn btn-3d w-100">
                    <i class="fas fa-redo me-2"></i> 再診断
                </a>
            </div>
        </div>
        {% endif %}
        
        <!-- 診断履歴 -->
        {% if history %}
        <div class="card-3d mb-4">
            <div class="card-header">
                <h5 class="mb-0 text-white"><i class="fas fa-history me-2"></i> 診断履歴</h5>
            </div>
            <div class="card-body text-white">
                <div class="list-group list-group-flush">
                    {% for item in history %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">{{ item.date }}</small><br>
                            <span class="badge bg-secondary">{{ item.posture_type }}</span>
                        </div>
                        <div class="text-end">
                            <div class="fw-bold" style="color: {% if item.score >= 0.8 %}#10b981{% elif item.score >= 0.6 %}#f59e0b{% else %}#ef4444{% endif %};">
                                {{ "%.0f"|format(item.score * 100) }}
                            </div>
                            <small class="text-muted">{{ item.issues_count }}件の問題</small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- サマリー -->
        {% if summary and summary.get('average_score') %}
        <div class="card-3d">
            <div class="card-header">
                <h5 class="mb-0 text-white"><i class="fas fa-chart-bar me-2"></i> 過去30日のサマリー</h5>
            </div>
            <div class="card-body text-white">
                <div class="mb-3">
                    <strong>平均スコア:</strong>
                    <div class="display-6 fw-bold" style="color: #667eea;">
                        {{ "%.0f"|format(summary.average_score * 100) }}
                    </div>
                </div>
                
                <div class="mb-3">
                    <strong>診断回数:</strong> {{ summary.total_analyses }}回
                </div>
                
                {% if summary.most_common_issues %}
                <div>
                    <strong>よく見られる問題:</strong>
                    <ul class="list-unstyled mt-2">
                        {% for issue in summary.most_common_issues[:3] %}
                        <li class="mb-1">
                            <small>{{ issue.type }} ({{ issue.count }}回)</small>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let video = null;
    let canvas = null;
    let stream = null;
    let isAnalyzing = false;
    let analysisInterval = null;
    
    // カメラの初期化
    async function initCamera() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user' 
                } 
            });
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            
            video.srcObject = stream;
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            console.log('カメラが初期化されました');
        } catch (error) {
            console.error('カメラの初期化に失敗しました:', error);
            alert('カメラへのアクセスに失敗しました。ブラウザの設定を確認してください。');
        }
    }
    
    // 姿勢診断開始
    async function startPostureDiagnosis() {
        if (!video || !stream) {
            await initCamera();
        }
        
        if (!stream) {
            alert('カメラにアクセスできません。');
            return;
        }
        
        isAnalyzing = true;
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('captureBtn').disabled = false;
        
        // 定期的に姿勢を分析（5秒ごと）
        analysisInterval = setInterval(() => {
            analyzeCurrentPosture();
        }, 5000);
        
        // 最初の分析を即座に実行
        analyzeCurrentPosture();
    }
    
    // 姿勢診断停止
    function stopPostureDiagnosis() {
        isAnalyzing = false;
        document.getElementById('startBtn').disabled = false;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('captureBtn').disabled = true;
        
        if (analysisInterval) {
            clearInterval(analysisInterval);
            analysisInterval = null;
        }
    }
    
    // 現在の姿勢を分析
    async function capturePosture() {
        await analyzeCurrentPosture(true);
    }
    
    // 姿勢を分析
    async function analyzeCurrentPosture(showResult = true) {
        if (!video || !canvas) {
            console.error('カメラが初期化されていません');
            return;
        }
        
        // フレームをキャプチャ
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // 画像をBase64にエンコード
        const imageData = canvas.toDataURL('image/jpeg', 0.8);
        
        // APIに送信（画像データを送信すると、サーバー側でYOLOを使用してキーポイントを検出）
        const postureType = document.getElementById('postureType').value;
        const userId = '{{ user.user_id }}';
        
        try {
            const response = await fetch('/api/posture/analyze', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    user_id: userId,
                    image: imageData,  // 画像データを送信（サーバー側でYOLO検出）
                    posture_type: postureType
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success' && showResult) {
                displayAnalysisResult(data.analysis);
            } else if (data.status === 'error') {
                console.error('姿勢分析エラー:', data.message);
                alert('姿勢分析に失敗しました: ' + data.message);
            }
        } catch (error) {
            console.error('姿勢分析エラー:', error);
            alert('姿勢分析に失敗しました。');
        }
    }
    
    // 分析結果を表示
    function displayAnalysisResult(analysis) {
        const resultCard = document.getElementById('resultCard');
        const resultContent = document.getElementById('resultContent');
        
        let html = `
            <div class="text-center mb-4">
                <div class="display-3 fw-bold" style="color: ${getScoreColor(analysis.overall_score)};">
                    ${Math.round(analysis.overall_score * 100)}
                </div>
                <div class="text-muted">総合姿勢スコア</div>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6><i class="fas fa-chart-pie"></i> 整列スコア</h6>
                    <ul class="list-unstyled">
        `;
        
        for (const [key, value] of Object.entries(analysis.alignment_scores)) {
            html += `
                <li class="mb-2">
                    <div class="d-flex justify-content-between">
                        <span>${getAlignmentLabel(key)}</span>
                        <span class="badge bg-${getScoreBadgeColor(value)}">${Math.round(value * 100)}</span>
                    </div>
                    <div class="progress" style="height: 5px;">
                        <div class="progress-bar bg-${getScoreBadgeColor(value)}" style="width: ${value * 100}%"></div>
                    </div>
                </li>
            `;
        }
        
        html += `
                    </ul>
                </div>
                <div class="col-md-6">
        `;
        
        if (analysis.issues && analysis.issues.length > 0) {
            html += `
                    <h6><i class="fas fa-exclamation-triangle"></i> 検出された問題</h6>
                    <ul class="list-unstyled">
            `;
            
            for (const issue of analysis.issues) {
                html += `
                        <li class="mb-2">
                            <span class="badge bg-${getSeverityColor(issue.severity)} me-2">${issue.severity}</span>
                            ${issue.description}
                            <br><small class="text-muted">${issue.impact}</small>
                        </li>
                `;
            }
            
            html += `</ul>`;
        } else {
            html += `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> 問題は検出されませんでした。良好な姿勢です！
                    </div>
            `;
        }
        
        html += `
                </div>
            </div>
            
            <div class="card bg-light">
                <div class="card-body">
                    <h6><i class="fas fa-lightbulb"></i> 改善提案</h6>
                    <ul class="mb-0">
        `;
        
        for (const rec of analysis.recommendations) {
            html += `<li>${rec}</li>`;
        }
        
        html += `
                    </ul>
                </div>
            </div>
        `;
        
        resultContent.innerHTML = html;
        resultCard.style.display = 'block';
        resultCard.scrollIntoView({ behavior: 'smooth' });
    }
    
    function getScoreColor(score) {
        if (score >= 0.8) return '#10b981';
        if (score >= 0.6) return '#f59e0b';
        return '#ef4444';
    }
    
    function getScoreBadgeColor(score) {
        if (score >= 0.8) return 'success';
        if (score >= 0.6) return 'warning';
        return 'danger';
    }
    
    function getSeverityColor(severity) {
        if (severity === 'high') return 'danger';
        if (severity === 'medium') return 'warning';
        return 'info';
    }
    
    function getAlignmentLabel(key) {
        const labels = {
            'shoulder_alignment': '肩の水平度',
            'hip_alignment': '骨盤の水平度',
            'head_alignment': '頭部の位置',
            'spine_alignment': '背骨の整列',
            'knee_alignment': '膝の位置'
        };
        return labels[key] || key;
    }
    
    // ページ読み込み時にカメラを初期化
    document.addEventListener('DOMContentLoaded', function() {
        initCamera();
    });
    
    // ページを離れる際にカメラを停止
    window.addEventListener('beforeunload', function() {
        stopPostureDiagnosis();
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
    });
</script>
{% endblock %}

