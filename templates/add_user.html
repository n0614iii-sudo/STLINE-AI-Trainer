{% extends "base.html" %}

{% block title %}新規ユーザー登録 - パーソナルジム AI{% endblock %}
{% block page_title %}新規ユーザー登録{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-user-plus"></i> 新規ユーザー登録
            </div>
            <div class="card-body">
                <form method="POST" id="userForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="user_id" class="form-label">ユーザーID <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="user_id" name="user_id" required 
                                       pattern="[a-zA-Z0-9_]+" placeholder="例: user001">
                                <div class="form-text">英数字とアンダースコアのみ使用可能</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="name" class="form-label">名前 <span class="text-danger">*</span></label>
                                <input type="text" class="form-control" id="name" name="name" required 
                                       placeholder="例: 田中太郎">
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="fitness_level" class="form-label">フィットネスレベル <span class="text-danger">*</span></label>
                                <select class="form-select" id="fitness_level" name="fitness_level" required>
                                    <option value="">選択してください</option>
                                    <option value="beginner">初心者 - 運動習慣がない、基本から学びたい</option>
                                    <option value="intermediate">中級者 - 定期的に運動している</option>
                                    <option value="advanced">上級者 - 本格的なトレーニング経験がある</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="preferred_language" class="form-label">使用言語</label>
                                <select class="form-select" id="preferred_language" name="preferred_language">
                                    <option value="ja">日本語</option>
                                    <option value="en">English</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="target_goals" class="form-label">目標 <span class="text-danger">*</span></label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="weight_loss" id="goal_weight_loss">
                                    <label class="form-check-label" for="goal_weight_loss">
                                        体重減少・ダイエット
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="muscle_gain" id="goal_muscle_gain">
                                    <label class="form-check-label" for="goal_muscle_gain">
                                        筋肉増強・筋力向上
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="endurance" id="goal_endurance">
                                    <label class="form-check-label" for="goal_endurance">
                                        体力・持久力向上
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="flexibility" id="goal_flexibility">
                                    <label class="form-check-label" for="goal_flexibility">
                                        柔軟性・可動域改善
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="posture" id="goal_posture">
                                    <label class="form-check-label" for="goal_posture">
                                        姿勢改善
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="general_fitness" id="goal_general">
                                    <label class="form-check-label" for="goal_general">
                                        一般的な健康維持
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">一つまたは複数選択可能</div>
                    </div>

                    <div class="mb-3">
                        <label for="physical_limitations" class="form-label">身体的制約・注意事項</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="knee_issues" id="limit_knee">
                                    <label class="form-check-label" for="limit_knee">
                                        膝の問題
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="back_issues" id="limit_back">
                                    <label class="form-check-label" for="limit_back">
                                        腰・背中の問題
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="shoulder_issues" id="limit_shoulder">
                                    <label class="form-check-label" for="limit_shoulder">
                                        肩の問題
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="heart_conditions" id="limit_heart">
                                    <label class="form-check-label" for="limit_heart">
                                        心疾患
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="high_blood_pressure" id="limit_bp">
                                    <label class="form-check-label" for="limit_bp">
                                        高血圧
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="other" id="limit_other">
                                    <label class="form-check-label" for="limit_other">
                                        その他
                                    </label>
                                </div>
                            </div>
                        </div>
                        <textarea class="form-control mt-2" id="limitations_notes" placeholder="その他の制約や詳細があれば記入してください"></textarea>
                    </div>

                    <hr>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('users_list') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> キャンセル
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 登録
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.getElementById('userForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        // 目標の収集
        const goals = [];
        document.querySelectorAll('input[type="checkbox"][value]:checked').forEach(checkbox => {
            if (checkbox.id.startsWith('goal_')) {
                goals.push(checkbox.value);
            }
        });
        
        if (goals.length === 0) {
            alert('少なくとも一つの目標を選択してください。');
            return;
        }
        
        // 身体的制約の収集
        const limitations = [];
        document.querySelectorAll('input[type="checkbox"][value]:checked').forEach(checkbox => {
            if (checkbox.id.startsWith('limit_')) {
                limitations.push(checkbox.value);
            }
        });
        
        const formData = {
            user_id: document.getElementById('user_id').value,
            name: document.getElementById('name').value,
            fitness_level: document.getElementById('fitness_level').value,
            preferred_language: document.getElementById('preferred_language').value,
            target_goals: goals,
            physical_limitations: limitations
        };
        
        // 注意事項があれば追加
        const notes = document.getElementById('limitations_notes').value.trim();
        if (notes) {
            limitations.push('notes:' + notes);
        }
        
        fetch('/add_user', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('ユーザーが正常に登録されました！');
                window.location.href = '{{ url_for("users_list") }}';
            } else {
                alert('エラー: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('登録に失敗しました。');
        });
    });
    
    // ユーザーIDの重複チェック（簡易版）
    document.getElementById('user_id').addEventListener('blur', function() {
        const userId = this.value;
        if (userId) {
            // 実際の実装では、サーバーサイドで重複チェックを行う
            console.log('Checking user ID:', userId);
        }
    });
</script>
{% endblock %}