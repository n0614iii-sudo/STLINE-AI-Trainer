{% extends "base.html" %}

{% block title %}{{ user.name }} - ユーザー詳細{% endblock %}
{% block page_title %}{{ user.name }} さんの詳細{% endblock %}

{% block content %}
<div class="row">
    <!-- ユーザー基本情報 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-user"></i> 基本情報
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <div class="rounded-circle bg-primary text-white d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                        <i class="fas fa-user fa-3x"></i>
                    </div>
                    <h4 class="mt-3">{{ user.name }}</h4>
                    <code class="text-muted">{{ user.user_id }}</code>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <strong>フィットネスレベル:</strong><br>
                    {% if user.fitness_level == 'beginner' %}
                        <span class="badge bg-success fs-6">初心者</span>
                    {% elif user.fitness_level == 'intermediate' %}
                        <span class="badge bg-warning fs-6">中級者</span>
                    {% else %}
                        <span class="badge bg-danger fs-6">上級者</span>
                    {% endif %}
                </div>
                
                <div class="mb-3">
                    <strong>目標:</strong><br>
                    {% for goal in user.target_goals %}
                        <span class="badge bg-info me-1">
                            {% if goal == 'weight_loss' %}減量
                            {% elif goal == 'muscle_gain' %}筋肉増強
                            {% elif goal == 'endurance' %}持久力
                            {% elif goal == 'flexibility' %}柔軟性
                            {% elif goal == 'posture' %}姿勢改善
                            {% elif goal == 'general_fitness' %}健康維持
                            {% else %}{{ goal }}{% endif %}
                        </span>
                    {% endfor %}
                </div>
                
                {% if user.physical_limitations %}
                <div class="mb-3">
                    <strong>身体的制約:</strong><br>
                    {% for limitation in user.physical_limitations %}
                        <span class="badge bg-warning me-1">{{ limitation }}</span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="mb-3">
                    <strong>使用言語:</strong> {{ user.preferred_language }}
                </div>
            </div>
        </div>
        
        <!-- クイックアクション -->
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-bolt"></i> アクション
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-success" onclick="startSessionForUser('{{ user.user_id }}')">
                        <i class="fas fa-play"></i> セッション開始
                    </button>
                    <button class="btn btn-info" onclick="showProgressChart()">
                        <i class="fas fa-chart-line"></i> 進捗グラフ
                    </button>
                    <button class="btn btn-warning" onclick="exportUserData()">
                        <i class="fas fa-download"></i> データエクスポート
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 統計情報 -->
    <div class="col-md-8">
        <!-- 統計カード -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center text-white">
                        <i class="fas fa-calendar-alt fa-2x mb-2"></i>
                        <h5>{{ summary.get('total_sessions', 0) }}</h5>
                        <small>総セッション数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center text-white">
                        <i class="fas fa-redo fa-2x mb-2"></i>
                        <h5>{{ summary.get('total_reps', 0) }}</h5>
                        <small>総回数</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center text-white">
                        <i class="fas fa-fire fa-2x mb-2"></i>
                        <h5>{{ summary.get('total_calories', 0) }}</h5>
                        <small>総消費カロリー</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card stats-card">
                    <div class="card-body text-center text-white">
                        <i class="fas fa-star fa-2x mb-2"></i>
                        <h5>{{ summary.get('average_form_score', 0) }}</h5>
                        <small>平均フォームスコア</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 改善提案 -->
        {% if summary.get('improvement_suggestions') %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <i class="fas fa-lightbulb"></i> 改善提案
            </div>
            <div class="card-body">
                <ul class="list-unstyled mb-0">
                    {% for suggestion in summary.improvement_suggestions %}
                    <li class="mb-2">
                        <i class="fas fa-arrow-right text-info me-2"></i>
                        {{ suggestion }}
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        
        <!-- セッション履歴 -->
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <span><i class="fas fa-history"></i> セッション履歴</span>
                    <button class="btn btn-sm btn-outline-primary" onclick="toggleAllSessions()">
                        <span id="toggleText">すべて表示</span>
                    </button>
                </div>
            </div>
            <div class="card-body">
                {% if sessions %}
                <div class="table-responsive">
                    <table class="table table-hover" id="sessionsTable">
                        <thead class="table-light">
                            <tr>
                                <th>日時</th>
                                <th>運動</th>
                                <th>回数</th>
                                <th>スコア</th>
                                <th>カロリー</th>
                                <th>時間</th>
                                <th>フィードバック</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in sessions %}
                            <tr {% if loop.index > 10 %}class="collapse additional-sessions"{% endif %}>
                                <td>{{ session.date }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ session.exercise }}</span>
                                </td>
                                <td>{{ session.reps }}回</td>
                                <td>
                                    {% if session.form_score >= 0.8 %}
                                        <span class="badge bg-success">{{ session.form_score }}</span>
                                    {% elif session.form_score >= 0.6 %}
                                        <span class="badge bg-warning">{{ session.form_score }}</span>
                                    {% else %}
                                        <span class="badge bg-danger">{{ session.form_score }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ session.calories }}kcal</td>
                                <td>{{ session.duration }}</td>
                                <td>
                                    {% if session.feedback_count > 0 %}
                                        <span class="badge bg-info">{{ session.feedback_count }}件</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted">
                    <i class="fas fa-inbox fa-3x mb-3"></i>
                    <p>まだセッションデータがありません</p>
                    <button class="btn btn-primary" onclick="startSessionForUser('{{ user.user_id }}')">
                        最初のセッションを始める
                    </button>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- セッション開始モーダル -->
<div class="modal fade" id="sessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{{ user.name }}さんのセッション開始</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sessionForm">
                    <input type="hidden" id="userId" value="{{ user.user_id }}">
                    <div class="mb-3">
                        <label for="exerciseType" class="form-label">運動種目</label>
                        <select class="form-select" id="exerciseType" required>
                            <option value="">選択してください</option>
                            <option value="squat">スクワット</option>
                            <option value="push_up">腕立て伏せ</option>
                            <option value="deadlift">デッドリフト</option>
                            <option value="plank">プランク</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">今回の目標</label>
                        <div class="form-text mb-2">前回の記録を参考に目標を設定してください</div>
                        {% if sessions %}
                            {% set latest_session = sessions[0] %}
                            <div class="alert alert-info">
                                <strong>前回の{{ latest_session.exercise }}:</strong> {{ latest_session.reps }}回 (フォームスコア: {{ latest_session.form_score }})
                            </div>
                        {% endif %}
                        <input type="number" class="form-control" id="targetReps" placeholder="目標回数">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                <button type="button" class="btn btn-primary" onclick="submitSession()">セッション開始</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let showingAllSessions = false;
    
    function startSessionForUser(userId) {
        const modal = new bootstrap.Modal(document.getElementById('sessionModal'));
        modal.show();
    }

    function submitSession() {
        const userId = document.getElementById('userId').value;
        const exerciseType = document.getElementById('exerciseType').value;
        const targetReps = document.getElementById('targetReps').value;
        
        if (!exerciseType) {
            alert('運動種目を選択してください。');
            return;
        }

        fetch('/start_session', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                user_id: userId,
                exercise_type: exerciseType,
                target_reps: targetReps ? parseInt(targetReps) : null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                alert('セッションが開始されました！AIトレーナーとのセッションを開始してください。');
                bootstrap.Modal.getInstance(document.getElementById('sessionModal')).hide();
                
                if (confirm('AIトレーナーとのセッションを開始しますか？\n新しいタブでトレーニング画面が開きます。')) {
                    window.open('about:blank', '_blank'); // 実際のVision Agentsセッション画面のURLに置き換え
                }
            } else {
                alert('エラー: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('セッション開始に失敗しました。');
        });
    }
    
    function toggleAllSessions() {
        const additionalSessions = document.querySelectorAll('.additional-sessions');
        const toggleText = document.getElementById('toggleText');
        
        if (showingAllSessions) {
            additionalSessions.forEach(row => row.classList.add('collapse'));
            toggleText.textContent = 'すべて表示';
            showingAllSessions = false;
        } else {
            additionalSessions.forEach(row => row.classList.remove('collapse'));
            toggleText.textContent = '折りたたむ';
            showingAllSessions = true;
        }
    }
    
    function showProgressChart() {
        alert('進捗グラフ機能は実装中です。');
        // 実際の実装では、Chart.jsを使用して進捗グラフを表示
    }
    
    function exportUserData() {
        const userId = '{{ user.user_id }}';
        
        // ユーザーデータをJSON形式でダウンロード
        fetch(`/api/user/${userId}/export`)
            .then(response => response.json())
            .then(data => {
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                const exportFileDefaultName = `user_${userId}_data.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
            })
            .catch(error => {
                console.error('Export failed:', error);
                alert('データのエクスポートに失敗しました。');
            });
    }
</script>
{% endblock %}